<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flashcards Admin • New</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/new-common.css" />
    <link rel="stylesheet" href="/styles/admin-new.css" />
  </head>
  <body>
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="logo">PP</div>
          <div>
            <div class="brand-name">Paramedic Prep Admin</div>
            <div class="brand-sub">Question Management</div>
          </div>
        </div>
        <div class="select-wrap">
          <select id="deckSelect"></select>
          <span class="chevron">▾</span>
        </div>
        <div class="title-edit">
          <label for="deckTitle">Lesson title</label>
          <input id="deckTitle" type="text" placeholder="Enter lesson title" />
        </div>
        <div class="controls">
          <a href="/index.html" class="btn ghost">Open learner view</a>
          <button id="addCard" class="btn">Add Card</button>
          <button id="deleteDeck" class="btn danger ghost">Delete deck</button>
          <button id="saveBtn" class="btn primary">Save Changes</button>
        </div>
      </div>
    </header>

    <main>
      <div class="grid">
        <section class="metrics">
          <div class="metric">
            <div class="label">Total Questions</div>
            <div class="value" id="statTotal">0</div>
            <div class="pill">All cards in deck</div>
          </div>
          <div class="metric">
            <div class="label">With Media</div>
            <div class="value" id="statMedia">0</div>
            <div class="pill">Images attached</div>
          </div>
          <div class="metric">
            <div class="label">Unanswered</div>
            <div class="value" id="statEmpty">0</div>
            <div class="pill">Missing text fields</div>
          </div>
        </section>

        <section class="panel">
          <div class="toolbar">
            <div class="status" id="status">Load a deck to begin.</div>
            <div class="row">
              <button id="addCardInline" class="btn ghost">Quick add</button>
              <button id="saveInline" class="btn primary">Save</button>
            </div>
          </div>
        </section>

        <section class="card-list" id="cards"></section>
      </div>
    </main>

    <script>
      const deckSelect = document.getElementById("deckSelect");
      const deckTitleInput = document.getElementById("deckTitle");
      const cardsEl = document.getElementById("cards");
      const statusEl = document.getElementById("status");
      const addBtn = document.getElementById("addCard");
      const addInlineBtn = document.getElementById("addCardInline");
      const saveBtn = document.getElementById("saveBtn");
      const saveInlineBtn = document.getElementById("saveInline");
      const deleteBtn = document.getElementById("deleteDeck");
      const statTotal = document.getElementById("statTotal");
      const statMedia = document.getElementById("statMedia");
      const statEmpty = document.getElementById("statEmpty");

      let deckId = null;
      let deckTitle = "";
      let cards = [];

      init();

      async function init() {
        await loadDecks();
        deckSelect.onchange = () => loadDeck(deckSelect.value);
        deckTitleInput.oninput = (e) => (deckTitle = e.target.value);
        addBtn.onclick = addCard;
        addInlineBtn.onclick = addCard;
        saveBtn.onclick = save;
        saveInlineBtn.onclick = save;
        deleteBtn.onclick = deleteDeck;
      }

      function extractNumericPrefix(title) {
        // Extract numeric prefix from title (e.g., "01-Lesson" -> 1, "10-Lesson" -> 10)
        const match = String(title).match(/^0?(\d+)/);
        return match ? parseInt(match[1], 10) : 9999; // Put non-numeric titles at the end
      }

      async function loadDecks(preselectId = null) {
        const res = await fetch("/api/decks");
        if (!res.ok) {
          statusEl.textContent = "Unable to load decks.";
          return;
        }
        const data = await res.json();
        deckSelect.innerHTML = "";
        const decks = (data.decks || []).sort((a, b) => {
          const numA = extractNumericPrefix(a.title);
          const numB = extractNumericPrefix(b.title);
          return numA - numB;
        });
        if (!decks.length) {
          deckId = null;
          deckTitle = "";
          deckTitleInput.value = "";
          cards = [];
          render();
          statusEl.textContent = "No decks available.";
          return;
        }
        decks.forEach((d, i) => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.title;
          if (i === 0) opt.selected = true;
          deckSelect.appendChild(opt);
        });
        const desiredId =
          preselectId && decks.some((d) => String(d.id) === String(preselectId)) ? preselectId : decks[0]?.id || null;
        if (desiredId) {
          deckSelect.value = desiredId;
          await loadDeck(desiredId);
        }
      }

      async function loadDeck(id) {
        deckId = id;
        const res = await fetch(`/api/decks/${id}`);
        if (!res.ok) {
          statusEl.textContent = "Unable to load deck.";
          return;
        }
        const data = await res.json();
        deckTitle = data.title || "";
        deckTitleInput.value = deckTitle;
        cards = data.cards.map((c) => ({
          ...c,
          id: c.id,
          imageData: null,
          answerImageData: null,
          removeImage: false,
          removeAnswerImage: false,
          expanded: false,
        }));
        render();
      }

      function render() {
        cardsEl.innerHTML = "";
        cards.forEach((card, idx) => {
          const wrapper = document.createElement("div");
          wrapper.className = "card-row";
          wrapper.dataset.idx = idx;

          const header = document.createElement("div");
          header.className = "card-header";
          header.onclick = () => {
            card.expanded = !card.expanded;
            render();
          };

          const title = document.createElement("div");
          title.className = "card-title";
          title.innerHTML = `<span class="id">#${idx + 1}</span><span class="text">${truncate(
            card.question || "(untitled)",
            90
          )}</span>`;

          const right = document.createElement("div");
          right.className = "chips";
          if (card.image || card.imageData || card.answerImage || card.answerImageData) {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = "Media";
            right.appendChild(chip);
          }
          if (!card.question || !card.answer) {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = "Incomplete";
            right.appendChild(chip);
          }
          const caret = document.createElement("span");
          caret.className = "caret" + (card.expanded ? " open" : "");
          caret.textContent = "▾";
          right.appendChild(caret);

          header.appendChild(title);
          header.appendChild(right);

          const body = document.createElement("div");
          body.className = "card-body";
          body.style.display = card.expanded ? "grid" : "none";

          body.appendChild(buildTextarea("Question", card.question || "", (val) => (card.question = val)));
          body.appendChild(buildTextarea("Answer", card.answer || "", (val) => (card.answer = val)));

          body.appendChild(buildImageRow("Question image", idx, "image"));
          body.appendChild(buildImageRow("Answer image", idx, "answerImage"));

          wrapper.appendChild(header);
          wrapper.appendChild(body);
          cardsEl.appendChild(wrapper);
        });
        renderStats();
        statusEl.textContent = `Editing ${cards.length} cards`;
      }

      function buildTextarea(labelText, value, onInput) {
        const container = document.createElement("div");
        const label = document.createElement("label");
        label.textContent = labelText;
        const area = document.createElement("textarea");
        area.value = value;
        area.oninput = (e) => onInput(e.target.value);
        container.appendChild(label);
        container.appendChild(area);
        return container;
      }

      function buildImageRow(label, idx, field) {
        const isAnswer = field === "answerImage";
        const container = document.createElement("div");
        container.className = "image-row";

        const drop = document.createElement("div");
        drop.className = "drop";
        drop.textContent = `${label}: Drop or click to upload`;
        drop.onclick = () => chooseFile(idx, field);
        drop.ondragover = (e) => {
          e.preventDefault();
          drop.style.borderColor = "var(--accent)";
        };
        drop.ondragleave = () => (drop.style.borderColor = "var(--border)");
        drop.ondrop = (e) => {
          e.preventDefault();
          drop.style.borderColor = "var(--border)";
          if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], idx, field);
        };

        const previewRow = document.createElement("div");
        previewRow.className = "row";
        const url =
          (isAnswer ? cards[idx].answerImageData : cards[idx].imageData) ||
          (isAnswer ? cards[idx].answerImage : cards[idx].image) ||
          (isAnswer ? cards[idx].answerImagePath : cards[idx].imagePath);
        if (url) {
          const img = document.createElement("img");
          img.src = url;
          img.className = "thumb";
          previewRow.appendChild(img);
          const removeBtn = document.createElement("button");
          removeBtn.className = "btn";
          removeBtn.textContent = "Remove";
          removeBtn.onclick = () => {
            if (isAnswer) {
              cards[idx].answerImageData = null;
              cards[idx].answerImage = null;
              cards[idx].answerImagePath = null;
              cards[idx].removeAnswerImage = true;
            } else {
              cards[idx].imageData = null;
              cards[idx].image = null;
              cards[idx].imagePath = null;
              cards[idx].removeImage = true;
            }
            render();
          };
          previewRow.appendChild(removeBtn);
        } else {
          const empty = document.createElement("span");
          empty.className = "pill-small";
          empty.textContent = "No image";
          previewRow.appendChild(empty);
        }

        container.appendChild(drop);
        container.appendChild(previewRow);
        return container;
      }

      function addCard() {
        cards.push({
          id: null,
          question: "",
          answer: "",
          image: null,
          imageData: null,
          answerImage: null,
          answerImageData: null,
          removeImage: false,
          removeAnswerImage: false,
          expanded: true,
        });
        render();
        const last = cardsEl.lastElementChild;
        if (last) {
          last.scrollIntoView({ behavior: "smooth", block: "start" });
          const textarea = last.querySelector("textarea");
          if (textarea) textarea.focus();
        }
      }

      function chooseFile(idx, field = "image") {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = () => {
          if (input.files && input.files[0]) handleFile(input.files[0], idx, field);
        };
        input.click();
      }

      function handleFile(file, idx, field = "image") {
        const reader = new FileReader();
        reader.onload = () => {
          if (field === "answerImage") {
            cards[idx].answerImageData = reader.result;
            cards[idx].answerImage = null;
            cards[idx].removeAnswerImage = false;
          } else {
            cards[idx].imageData = reader.result;
            cards[idx].image = null;
            cards[idx].removeImage = false;
          }
          render();
        };
        reader.readAsDataURL(file);
      }

      async function save() {
        statusEl.textContent = "Saving...";
        const title = (deckTitle || deckTitleInput.value || "").trim();
        if (!title) {
          statusEl.textContent = "Deck title is required.";
          return;
        }
        deckTitle = title;
        const payload = {
          title,
          cards: cards.map((c) => ({
            id: c.id,
            question: c.question,
            answer: c.answer,
            imageData: c.imageData || null,
            imagePath: c.image && !c.imageData && !c.removeImage ? c.image : null,
            removeImage: !!c.removeImage,
            answerImageData: c.answerImageData || null,
            answerImagePath: c.answerImage && !c.answerImageData && !c.removeAnswerImage ? c.answerImage : null,
            removeAnswerImage: !!c.removeAnswerImage,
          })),
        };
        const res = await fetch(`/api/admin/decks/${deckId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          statusEl.textContent = "Save failed";
          return;
        }
        const result = await res.json().catch(() => ({}));
        statusEl.textContent = "Saved";
        deckTitle = result.title || deckTitle;
        deckTitleInput.value = deckTitle;
        const option = Array.from(deckSelect.options).find((opt) => opt.value === String(deckId));
        if (option) option.textContent = deckTitle;
        await loadDeck(deckId);
      }

      async function deleteDeck() {
        if (!deckId) return;
        const name = (deckTitleInput.value || deckTitle || "this deck").trim();
        const confirmed = window.confirm(`Delete "${name}" and all of its questions? This cannot be undone.`);
        if (!confirmed) return;
        statusEl.textContent = "Deleting deck...";
        const res = await fetch(`/api/admin/decks/${deckId}`, { method: "DELETE" });
        if (!res.ok) {
          statusEl.textContent = "Delete failed.";
          return;
        }
        statusEl.textContent = "Deck deleted.";
        await loadDecks();
      }

      function truncate(str, max) {
        if (!str) return "";
        if (str.length <= max) return str;
        return str.slice(0, max - 1) + "…";
      }

      function renderStats() {
        const total = cards.length;
        const withMedia = cards.filter((c) => c.image || c.imageData || c.answerImage || c.answerImageData).length;
        const incomplete = cards.filter((c) => !c.question || !c.answer).length;
        statTotal.textContent = total;
        statMedia.textContent = withMedia;
        statEmpty.textContent = incomplete;
      }
    </script>
  </body>
</html>
