<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flashcards Admin • New</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/new-common.css" />
    <link rel="stylesheet" href="/styles/admin-new.css" />
  </head>
  <body>
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="logo">PP</div>
          <div>
            <div class="brand-name">Paramedic Prep Admin</div>
            <div class="brand-sub">Question Management</div>
          </div>
        </div>
        <div class="select-wrap">
          <select id="deckSelect"></select>
          <span class="chevron">▾</span>
        </div>
        <div class="controls">
          <a href="/index.html" class="btn ghost">Open learner view</a>
          <button id="addCard" class="btn">Add Card</button>
          <button id="saveBtn" class="btn primary">Save Changes</button>
        </div>
      </div>
    </header>

    <main>
      <div class="grid">
        <section class="metrics">
          <div class="metric">
            <div class="label">Total Questions</div>
            <div class="value" id="statTotal">0</div>
            <div class="pill">All cards in deck</div>
          </div>
          <div class="metric">
            <div class="label">With Media</div>
            <div class="value" id="statMedia">0</div>
            <div class="pill">Images attached</div>
          </div>
          <div class="metric">
            <div class="label">Unanswered</div>
            <div class="value" id="statEmpty">0</div>
            <div class="pill">Missing text fields</div>
          </div>
        </section>

        <section class="panel">
          <div class="toolbar">
            <div class="status" id="status">Load a deck to begin.</div>
            <div class="row">
              <button id="addCardInline" class="btn ghost">Quick add</button>
              <button id="saveInline" class="btn primary">Save</button>
            </div>
          </div>
        </section>

        <section class="card-list" id="cards"></section>
      </div>
    </main>

    <script>
      const deckSelect = document.getElementById("deckSelect");
      const cardsEl = document.getElementById("cards");
      const statusEl = document.getElementById("status");
      const addBtn = document.getElementById("addCard");
      const addInlineBtn = document.getElementById("addCardInline");
      const saveBtn = document.getElementById("saveBtn");
      const saveInlineBtn = document.getElementById("saveInline");
      const statTotal = document.getElementById("statTotal");
      const statMedia = document.getElementById("statMedia");
      const statEmpty = document.getElementById("statEmpty");

      let deckId = null;
      let cards = [];

      init();

      async function init() {
        await loadDecks();
        deckSelect.onchange = () => loadDeck(deckSelect.value);
        addBtn.onclick = addCard;
        addInlineBtn.onclick = addCard;
        saveBtn.onclick = save;
        saveInlineBtn.onclick = save;
      }

      async function loadDecks() {
        const res = await fetch("/api/decks");
        const data = await res.json();
        deckSelect.innerHTML = "";
        data.decks.forEach((d, i) => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.title;
          if (i === 0) opt.selected = true;
          deckSelect.appendChild(opt);
        });
        if (data.decks[0]) await loadDeck(data.decks[0].id);
      }

      async function loadDeck(id) {
        deckId = id;
        const res = await fetch(`/api/decks/${id}`);
        const data = await res.json();
        cards = data.cards.map((c) => ({
          ...c,
          id: c.id,
          imageData: null,
          removeImage: false,
          expanded: false,
        }));
        render();
      }

      function render() {
        cardsEl.innerHTML = "";
        cards.forEach((card, idx) => {
          const wrapper = document.createElement("div");
          wrapper.className = "card-row";
          wrapper.dataset.idx = idx;

          const header = document.createElement("div");
          header.className = "card-header";
          header.onclick = () => {
            card.expanded = !card.expanded;
            render();
          };

          const title = document.createElement("div");
          title.className = "card-title";
          title.innerHTML = `<span class="id">#${idx + 1}</span><span class="text">${truncate(
            card.question || "(untitled)",
            90
          )}</span>`;

          const right = document.createElement("div");
          right.className = "chips";
          if (card.image || card.imageData) {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = "Media";
            right.appendChild(chip);
          }
          if (!card.question || !card.answer) {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = "Incomplete";
            right.appendChild(chip);
          }
          const caret = document.createElement("span");
          caret.className = "caret" + (card.expanded ? " open" : "");
          caret.textContent = "▾";
          right.appendChild(caret);

          header.appendChild(title);
          header.appendChild(right);

          const body = document.createElement("div");
          body.className = "card-body";
          body.style.display = card.expanded ? "grid" : "none";

          body.appendChild(buildTextarea("Question", card.question || "", (val) => (card.question = val)));
          body.appendChild(buildTextarea("Answer", card.answer || "", (val) => (card.answer = val)));

          const imageRow = document.createElement("div");
          imageRow.className = "image-row";
          const drop = document.createElement("div");
          drop.className = "drop";
          drop.textContent = "Drop image or click to upload";
          drop.onclick = () => chooseFile(idx);
          drop.ondragover = (e) => {
            e.preventDefault();
            drop.style.borderColor = "var(--accent)";
          };
          drop.ondragleave = () => (drop.style.borderColor = "var(--border)");
          drop.ondrop = (e) => {
            e.preventDefault();
            drop.style.borderColor = "var(--border)";
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0], idx);
          };

          const previewRow = document.createElement("div");
          previewRow.className = "row";
          const url = card.imageData || card.image || card.imagePath;
          if (url) {
            const img = document.createElement("img");
            img.src = url;
            img.className = "thumb";
            previewRow.appendChild(img);
            const removeBtn = document.createElement("button");
            removeBtn.className = "btn";
            removeBtn.textContent = "Remove image";
            removeBtn.onclick = () => {
              card.imageData = null;
              card.image = null;
              card.imagePath = null;
              card.removeImage = true;
              render();
            };
            previewRow.appendChild(removeBtn);
          } else {
            const empty = document.createElement("span");
            empty.className = "pill-small";
            empty.textContent = "No image";
            previewRow.appendChild(empty);
          }

          imageRow.appendChild(drop);
          imageRow.appendChild(previewRow);
          body.appendChild(imageRow);

          wrapper.appendChild(header);
          wrapper.appendChild(body);
          cardsEl.appendChild(wrapper);
        });
        renderStats();
        statusEl.textContent = `Editing ${cards.length} cards`;
      }

      function buildTextarea(labelText, value, onInput) {
        const container = document.createElement("div");
        const label = document.createElement("label");
        label.textContent = labelText;
        const area = document.createElement("textarea");
        area.value = value;
        area.oninput = (e) => onInput(e.target.value);
        container.appendChild(label);
        container.appendChild(area);
        return container;
      }

      function addCard() {
        cards.push({
          id: null,
          question: "",
          answer: "",
          image: null,
          imageData: null,
          removeImage: false,
          expanded: true,
        });
        render();
        const last = cardsEl.lastElementChild;
        if (last) {
          last.scrollIntoView({ behavior: "smooth", block: "start" });
          const textarea = last.querySelector("textarea");
          if (textarea) textarea.focus();
        }
      }

      function chooseFile(idx) {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "image/*";
        input.onchange = () => {
          if (input.files && input.files[0]) handleFile(input.files[0], idx);
        };
        input.click();
      }

      function handleFile(file, idx) {
        const reader = new FileReader();
        reader.onload = () => {
          cards[idx].imageData = reader.result;
          cards[idx].image = null;
          cards[idx].removeImage = false;
          render();
        };
        reader.readAsDataURL(file);
      }

      async function save() {
        statusEl.textContent = "Saving...";
        const payload = {
          cards: cards.map((c) => ({
            id: c.id,
            question: c.question,
            answer: c.answer,
            imageData: c.imageData || null,
            imagePath: c.image && !c.imageData && !c.removeImage ? c.image : null,
            removeImage: !!c.removeImage,
          })),
        };
        const res = await fetch(`/api/admin/decks/${deckId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          statusEl.textContent = "Save failed";
          return;
        }
        statusEl.textContent = "Saved";
        await loadDeck(deckId);
      }

      function truncate(str, max) {
        if (!str) return "";
        if (str.length <= max) return str;
        return str.slice(0, max - 1) + "…";
      }

      function renderStats() {
        const total = cards.length;
        const withMedia = cards.filter((c) => c.image || c.imageData).length;
        const incomplete = cards.filter((c) => !c.question || !c.answer).length;
        statTotal.textContent = total;
        statMedia.textContent = withMedia;
        statEmpty.textContent = incomplete;
      }
    </script>
  </body>
</html>
