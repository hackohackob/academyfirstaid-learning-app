<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flashcards ‚Ä¢ New Session</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;600;700&family=Noto+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/styles/new-common.css" />
    <link rel="stylesheet" href="/styles/index-new.css" />
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  </head>
  <body>
    <div class="glow" aria-hidden="true"></div>
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="logo">PP</div>
          <div>
            <div class="brand-name">Paramedic Prep</div>
            <!-- <div class="brand-sub">Adaptive learning deck</div> -->
          </div>
        </div>
        <div class="select-block">
          <!-- <label for="deckSelect">Current lesson</label> -->
          <div class="select-wrap">
            <select id="deckSelect" aria-label="Deck selector"></select>
            <span class="chevron">‚ñæ</span>
          </div>
        </div>
        <div class="top-right">
          <div class="pill" id="progressShort">0 / 0</div>
          <div id="userArea" class="user-area"></div>
        </div>
      </div>
    </header>
    <main>
      <div class="layout">
        <section class="session">
          <div class="session-head">
            <div class="session-title">
              <h2>Session Progress</h2>
              <span class="muted" id="sessionMeta">Loading...</span>
            </div>
            <div class="pill-stack" id="pillRow"></div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="cards-grid">
            <article class="card">
              <div class="card-header">
                <span class="" id="deckBadge"></span>
                <div class="rating">
                  <button id="ratingUp" class="rate-btn" title="Thumbs up">üëç</button>
                  <button id="ratingDown" class="rate-btn" title="Thumbs down">üëé</button>
                </div>
              </div>
              <div id="imageFrame"></div>
              <div class="card-title" id="question">Loading‚Ä¶</div>
              <div class="status-row">
                <span class="muted" id="status">Stay focused</span>
              </div>
            </article>
            <article class="card answer-card">
              <div class="answer-title">
                <span>Answer</span>
                <button id="revealBtn" class="reveal-btn" type="button">Reveal (Space)</button>
              </div>
              <div id="answerImageFrame" class="answer-media"></div>
              <div class="answer-text" id="answer"></div>
              <div class="status-row muted" id="cardStats"></div>
            </article>
          </div>
          <div class="category-row" id="controls"></div>
          <div class="nav-row">
            <div class="rating muted" id="progress"></div>
            <div class="rating">
              <button class="btn" id="prevBtn" type="button">Previous</button>
              <button class="btn primary" id="nextBtn" type="button">Next</button>
            </div>
          </div>
        </section>
        <div id="emptyState" class="empty-state" style="display: none;">Please log in to view decks.</div>
      </div>
    </main>

    <div class="report-overlay" id="reportPanel" aria-hidden="true">
      <div class="report-card">
        <div class="report-head">
          <div>
            <div class="eyebrow">Profile</div>
            <h3>Lesson reports</h3>
            <div class="muted" id="reportSubtitle">Loading your progress...</div>
          </div>
          <div class="report-actions">
            <div class="report-legend" id="reportLegend"></div>
            <button class="btn" id="reportClose" type="button">Close</button>
          </div>
        </div>
        <div class="report-grid" id="reportGrid"></div>
      </div>
    </div>

    <div class="auth-panel" id="authPanel">
      <div class="auth-card">
        <h2 id="authTitle">Login</h2>
        <label for="authEmail">Email</label>
        <input id="authEmail" type="email" autocomplete="email" />
        <label for="authPassword">Password</label>
        <input id="authPassword" type="password" autocomplete="current-password" />
        <div id="nameRow">
          <label for="authName">Name</label>
          <input id="authName" type="text" autocomplete="name" />
        </div>
        <div class="auth-actions">
          <button id="authSubmit" class="btn primary" type="button">Submit</button>
          <button id="authCancel" class="linkish" type="button">Cancel</button>
        </div>
        <div class="muted" id="authStatus"></div>
      </div>
    </div>

    <script>
      const deckSelect = document.getElementById("deckSelect");
      const questionEl = document.getElementById("question");
      const answerEl = document.getElementById("answer");
      const progressEl = document.getElementById("progress");
      const progressShortEl = document.getElementById("progressShort");
      const statusEl = document.getElementById("status");
      const cardStatsEl = document.getElementById("cardStats");
      const pillRow = document.getElementById("pillRow");
      const controls = document.getElementById("controls");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const ratingUp = document.getElementById("ratingUp");
      const ratingDown = document.getElementById("ratingDown");
      const userArea = document.getElementById("userArea");
      const authPanel = document.getElementById("authPanel");
      const authTitle = document.getElementById("authTitle");
      const authEmail = document.getElementById("authEmail");
      const authPassword = document.getElementById("authPassword");
      const authName = document.getElementById("authName");
      const nameRow = document.getElementById("nameRow");
      const authSubmit = document.getElementById("authSubmit");
      const authCancel = document.getElementById("authCancel");
      const authStatus = document.getElementById("authStatus");
      const revealBtn = document.getElementById("revealBtn");
      const deckBadge = document.getElementById("deckBadge");
      const progressFill = document.getElementById("progressFill");
      const sessionMeta = document.getElementById("sessionMeta");
      const imageFrame = document.getElementById("imageFrame");
      const answerImageFrame = document.getElementById("answerImageFrame");
      const emptyState = document.getElementById("emptyState");
      const reportPanel = document.getElementById("reportPanel");
      const reportGrid = document.getElementById("reportGrid");
      const reportSubtitle = document.getElementById("reportSubtitle");
      const reportClose = document.getElementById("reportClose");
      const reportLegend = document.getElementById("reportLegend");

      let deck = null;
      let allCards = [];
      let cards = [];
      let index = 0;
      let categories = [];
      let progressMap = {};
      let showAnswer = false;
      let images = {};
      let answerImages = {};
      let ratings = {};
      let activeFilters = new Set();
      let currentUser = null;
      let authMode = "login";
      let reportData = [];

      init();

      async function init() {
        prevBtn.addEventListener("click", () => move(-1));
        nextBtn.addEventListener("click", () => move(1));
        ratingUp.addEventListener("click", () => selectRating("up"));
        ratingDown.addEventListener("click", () => selectRating("down"));
        authSubmit.onclick = submitAuth;
        authCancel.onclick = closeAuth;
        revealBtn.onclick = reveal;
        reportClose.onclick = closeReports;
        reportPanel.addEventListener("click", (e) => {
          if (e.target === reportPanel) closeReports();
        });
        window.addEventListener("keydown", handleKeys);
        await loadMe();
        renderUserArea();
        if (!currentUser) {
          showAuthPrompt();
          return;
        }
        await loadDecks();
      }

      async function loadDecks() {
        const res = await fetch("/api/decks");
        if (!res.ok) {
          showAuthPrompt();
          return;
        }
        const data = await res.json();
        deckSelect.innerHTML = "";
        data.decks.forEach((d, i) => {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.title;
          if (i === 0) opt.selected = true;
          deckSelect.appendChild(opt);
        });
        deckSelect.onchange = () => loadDeck(deckSelect.value);
        if (data.decks[0]) await loadDeck(data.decks[0].id);
      }

      async function loadDeck(id) {
        const res = await fetch(`/api/decks/${id}`);
        const data = await res.json();
        emptyState.style.display = "none";
        deck = data;
        allCards = shuffle(data.cards);
        cards = [...allCards];
        categories = data.categories;
        progressMap = data.progress || {};
        images = {};
        answerImages = {};
        ratings = data.ratings || {};
        cards.forEach((c) => {
          if (c.image) images[String(c.id)] = c.image;
          if (c.answerImage) answerImages[String(c.id)] = c.answerImage;
        });
        index = 0;
        activeFilters = new Set();
        renderCategories();
        renderCard();
      }

      function renderCategories() {
        controls.innerHTML = "";
        categories.forEach((cat) => {
          const btn = document.createElement("button");
          btn.className = "category-btn";
          btn.innerHTML = `<span>${cat}</span><span class="category-meta">Move card to ${cat}</span>`;
          btn.onclick = () => selectCategory(cat);
          btn.dataset.cat = cat.toLowerCase();
          btn.dataset.name = cat;
          controls.appendChild(btn);
        });
        decorateCategoryColors();
      }

      function decorateCategoryColors() {
        controls.querySelectorAll(".category-btn").forEach((btn) => {
          const cat = btn.dataset.cat || "";
          let color = "var(--accent)";
          if (cat.includes("again")) color = "var(--again)";
          if (cat.includes("hard")) color = "var(--hard)";
          if (cat.includes("good")) color = "var(--good)";
          if (cat.includes("easy")) color = "var(--accent-2)";
          btn.style.borderColor = color + "55";
          btn.style.color = "#e9f1ff";
        });
      }

      function renderCard() {
        renderPills();
        renderProgress();
        if (!cards.length) {
          questionEl.textContent = activeFilters.size ? "No cards match the selected difficulties." : "No cards.";
          answerEl.textContent = "";
          statusEl.textContent = activeFilters.size ? "Clear or change filters to continue." : "";
          cardStatsEl.textContent = "";
          imageFrame.innerHTML = "";
          if (answerImageFrame) {
            answerImageFrame.innerHTML = "";
            answerImageFrame.style.display = "none";
          }
          ratingUp.classList.remove("selected");
          ratingDown.classList.remove("selected");
          return;
        }
        if (!cards[index]) index = 0;
        const card = cards[index];
        questionEl.textContent = card.question;
        answerEl.textContent = showAnswer ? card.answer : "Press reveal to view the answer.";
        const current = progressMap[String(card.id)];
        statusEl.textContent = current ? `You marked this as ${current}` : "Not yet rated";
        [...controls.children].forEach((btn) => {
          btn.classList.toggle("selected", btn.dataset.name === current);
        });
        renderRating();
        renderImages(card);
        // deckBadge.textContent = deck.title || "Deck";
        // cardStatsEl.textContent = `Card ${index + 1} of ${cards.length}`;
      }

      function renderProgress() {
        const total = cards.length;
        const visibleIds = new Set(cards.map((c) => String(c.id)));
        const done = Object.entries(progressMap).filter(([id]) => visibleIds.has(id)).length;
        const pct = total ? Math.round((done / total) * 100) : 0;
        const slide = `${cards.length ? index + 1 : 0} / ${total || 0}`;
        progressEl.textContent = slide;
        progressShortEl.textContent = `${done} / ${total || 0}`;
        progressFill.style.width = `${pct}%`;
        sessionMeta.textContent = `${pct}% complete ¬∑ ${done} of ${total} reviewed`;
      }

      function renderPills() {
        pillRow.innerHTML = "";
        const summary = countCategories();
        categories.forEach((cat) => {
          const pill = document.createElement("button");
          pill.type = "button";
          pill.className = "pill-small filter-pill";
          pill.textContent = `${cat}: ${summary[cat] || 0}`;
          pill.dataset.cat = cat;
          pill.classList.toggle("selected", activeFilters.has(cat));
          pill.onclick = () => toggleFilter(cat);
          pillRow.appendChild(pill);
        });
      }

      function countCategories() {
        const counts = {};
        Object.values(progressMap).forEach((cat) => {
          counts[cat] = (counts[cat] || 0) + 1;
        });
        return counts;
      }

      function move(step) {
        if (!cards.length) return;
        index = (index + step + cards.length) % cards.length;
        showAnswer = false;
        renderCard();
      }

      function toggleFilter(cat) {
        if (activeFilters.has(cat)) {
          activeFilters.delete(cat);
        } else {
          activeFilters.add(cat);
        }
        applyFilters({ preserveIndex: true });
      }

      function applyFilters({ preserveIndex } = {}) {
        const currentId = preserveIndex && cards[index] ? cards[index].id : null;
        if (!activeFilters.size) {
          cards = [...allCards];
        } else {
          const selected = activeFilters;
          cards = allCards.filter((card) => selected.has(progressMap[String(card.id)]));
        }
        if (currentId) {
          const foundIndex = cards.findIndex((c) => c.id === currentId);
          index = foundIndex >= 0 ? foundIndex : 0;
        } else {
          index = 0;
        }
        showAnswer = false;
        renderCard();
      }

      async function selectCategory(cat) {
        if (!cards[index]) return;
        const card = cards[index];
        const key = String(card.id);
        progressMap[key] = cat;
        applyFilters({ preserveIndex: true });
        await fetch(`/api/decks/${deck.id}/progress`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cardId: card.id, category: cat }),
        });
        move(1);
      }

      function reveal() {
        showAnswer = true;
        renderCard();
      }

      function shuffle(list) {
        const arr = [...list];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function renderImages(card) {
        const key = String(card.id);
        const questionUrl = images[key];
        const answerUrl = answerImages[key];
        renderImageInto(imageFrame, questionUrl);
        if (showAnswer) {
          renderImageInto(answerImageFrame, answerUrl);
        } else if (answerImageFrame) {
          answerImageFrame.innerHTML = "";
          answerImageFrame.style.display = "none";
        }
      }

      function renderImageInto(frame, url) {
        if (!frame) return;
        frame.innerHTML = "";
        if (!url) {
          frame.style.display = "none";
          return;
        }
        frame.style.display = "block";
        const img = document.createElement("img");
        img.src = url;
        img.alt = "Card image";
        img.className = "question-img";
        frame.appendChild(img);
      }

      function renderRating() {
        if (!cards[index]) return;
        const card = cards[index];
        const key = String(card.id);
        const current = ratings[key];
        ratingUp.classList.toggle("selected", current === "up");
        ratingDown.classList.toggle("selected", current === "down");
      }

      async function selectRating(choice) {
        if (!cards[index]) return;
        const card = cards[index];
        const key = String(card.id);
        const newRating = ratings[key] === choice ? null : choice;
        ratings[key] = newRating;
        renderRating();
        await fetch(`/api/decks/${deck.id}/rating`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cardId: card.id, rating: newRating }),
        });
      }

      async function loadMe() {
        const res = await fetch("/api/me");
        if (!res.ok) {
          currentUser = null;
          return;
        }
        const data = await res.json();
        currentUser = data.user;
      }

      function renderUserArea() {
        userArea.innerHTML = "";
        if (!currentUser) {
          const loginBtn = document.createElement("button");
          loginBtn.textContent = "Login";
          loginBtn.className = "btn";
          loginBtn.onclick = () => openAuth("login");
          const regBtn = document.createElement("button");
          regBtn.textContent = "Sign up";
          regBtn.className = "btn primary";
          regBtn.onclick = () => openAuth("register");
          userArea.appendChild(loginBtn);
          userArea.appendChild(regBtn);
        } else {
          const avatar = document.createElement("div");
          avatar.className = "avatar";
          avatar.textContent = initials(currentUser.name || currentUser.email);
          avatar.title = `${currentUser.name} (${currentUser.email})`;
          avatar.style.cursor = "pointer";
          avatar.onclick = openReports;
          const reportBtn = document.createElement("button");
          reportBtn.className = "btn ghost";
          reportBtn.textContent = "Reports";
          reportBtn.onclick = openReports;
          if (currentUser.is_admin) {
            const adminBtn = document.createElement("a");
            adminBtn.className = "btn";
            adminBtn.textContent = "Admin";
            adminBtn.href = "/admin.html";
            userArea.appendChild(adminBtn);
          }
          userArea.appendChild(reportBtn);
          const logoutBtn = document.createElement("button");
          logoutBtn.className = "btn";
          logoutBtn.textContent = "Logout";
          logoutBtn.onclick = logout;
          userArea.appendChild(avatar);
          userArea.appendChild(logoutBtn);
        }
      }

      function openAuth(mode) {
        authMode = mode;
        authTitle.textContent = mode === "login" ? "Login" : "Create account";
        nameRow.style.display = mode === "login" ? "none" : "block";
        authStatus.textContent = "";
        authEmail.value = "";
        authPassword.value = "";
        authName.value = "";
        authPanel.style.display = "flex";
      }

      function closeAuth() {
        authPanel.style.display = "none";
      }

      function switchAuthMode() {
        openAuth(authMode === "login" ? "register" : "login");
      }

      async function submitAuth() {
        authStatus.textContent = "";
        const email = authEmail.value.trim();
        const password = authPassword.value;
        const name = authName.value.trim();
        if (!email || !password || (authMode === "register" && !name)) {
          authStatus.textContent = "Please fill all fields.";
          return;
        }
        const payload = authMode === "login" ? { email, password } : { email, password, name };
        const res = await fetch(authMode === "login" ? "/api/auth/login" : "/api/auth/register", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          authStatus.textContent = err.error || "Auth failed";
          return;
        }
        const data = await res.json();
        currentUser = data.user;
        closeAuth();
        renderUserArea();
        await loadDecks();
        if (!cards.length) showAuthPrompt();
      }

      async function logout() {
        await fetch("/api/auth/logout", { method: "POST" });
        currentUser = null;
        ratings = {};
        progressMap = {};
        renderUserArea();
        showAuthPrompt();
      }

      function showAuthPrompt() {
        questionEl.textContent = "Please log in to view decks.";
        answerEl.textContent = "";
        pillRow.innerHTML = "";
        controls.innerHTML = "";
        controls.appendChild(createLoginButtons());
        progressEl.textContent = "";
        ratingUp.classList.remove("selected");
        ratingDown.classList.remove("selected");
        progressFill.style.width = "0%";
        sessionMeta.textContent = "Authentication required to load study decks.";
        emptyState.style.display = "block";
        renderUserArea();
      }

      function createLoginButtons() {
        const wrapper = document.createElement("div");
        wrapper.className = "row";
        const loginBtn = document.createElement("button");
        loginBtn.textContent = "Login";
        loginBtn.className = "btn";
        loginBtn.onclick = () => openAuth("login");
        const regBtn = document.createElement("button");
        regBtn.textContent = "Sign up";
        regBtn.className = "btn primary";
        regBtn.onclick = () => openAuth("register");
        wrapper.appendChild(loginBtn);
        wrapper.appendChild(regBtn);
        return wrapper;
      }

      async function openReports() {
        if (!currentUser) return;
        reportPanel.classList.add("open");
        reportPanel.setAttribute("aria-hidden", "false");
        await loadReports();
      }

      function closeReports() {
        reportPanel.classList.remove("open");
        reportPanel.setAttribute("aria-hidden", "true");
      }

      async function loadReports() {
        reportSubtitle.textContent = "Loading your progress...";
        reportGrid.innerHTML = "";
        renderLegend();
        const res = await fetch("/api/reports/progress");
        if (!res.ok) {
          reportSubtitle.textContent = "Unable to load reports right now.";
          return;
        }
        const data = await res.json();
        reportData = data.decks || [];
        renderReportGrid(reportData);
      }

      function renderReportGrid(decks) {
        if (!decks.length) {
          reportSubtitle.textContent = "No study activity yet. Answer a few cards to see insights.";
          reportGrid.innerHTML = "";
          return;
        }
        const totalAnswered = decks.reduce((sum, d) => sum + (d.answered || 0), 0);
        const totalCards = decks.reduce((sum, d) => sum + (d.totalCards || 0), 0);
        reportSubtitle.textContent = `${totalAnswered} of ${totalCards} cards answered across ${decks.length} lessons`;
        reportGrid.innerHTML = "";
        decks.forEach((deck) => {
          const wrapper = document.createElement("div");
          wrapper.className = "report-item";

          const row = document.createElement("div");
          row.className = "report-row";
          const left = document.createElement("div");
          left.innerHTML = `<div class="eyebrow">Lesson</div><div style="font-weight: 700; font-size: 16px;">${deck.title}</div>`;
          const pill = document.createElement("div");
          pill.className = "pill-small";
          pill.textContent = `${deck.answered} / ${deck.totalCards} answered`;
          row.appendChild(left);
          row.appendChild(pill);

          const barHolder = document.createElement("div");
          barHolder.className = "report-bar";
          drawStackedBar(barHolder, deck);

          const meta = document.createElement("div");
          meta.className = "report-meta";
          const pct = deck.totalCards ? Math.round((deck.answered / deck.totalCards) * 100) : 0;
          meta.innerHTML = `<span class="report-score">${pct}% complete</span><span>¬∑</span><span>${deck.unanswered} unanswered</span>`;

          wrapper.appendChild(row);
          wrapper.appendChild(barHolder);
          wrapper.appendChild(meta);
          reportGrid.appendChild(wrapper);
        });
      }

      function drawStackedBar(container, deck) {
        const total = deck.totalCards || 1;
        const data = [
          { key: "Again", value: deck.categories?.Again || 0, color: getReportColor("Again") },
          { key: "Hard", value: deck.categories?.Hard || 0, color: getReportColor("Hard") },
          { key: "Good", value: deck.categories?.Good || 0, color: getReportColor("Good") },
          { key: "Easy", value: deck.categories?.Easy || 0, color: getReportColor("Easy") },
          { key: "Unanswered", value: deck.unanswered || 0, color: getReportColor("Unanswered") },
        ];
        const width = 100;
        const height = container.clientHeight || 18;
        const svg = d3
          .select(container)
          .html("")
          .append("svg")
          .attr("width", "100%")
          .attr("height", height)
          .attr("viewBox", `0 0 ${width} ${height}`)
          .attr("preserveAspectRatio", "none");

        let x = 0;
        data.forEach((d) => {
          if (!d.value) return;
          const w = (d.value / total) * width;
          svg
            .append("rect")
            .attr("x", x)
            .attr("y", 0)
            .attr("width", Math.max(w, 0))
            .attr("height", height)
            .attr("fill", d.color);
          x += w;
        });
      }

      function getReportColor(key) {
        if (key === "Again") return "var(--report-again)";
        if (key === "Hard") return "var(--report-hard)";
        if (key === "Good") return "var(--report-good)";
        if (key === "Easy") return "var(--report-easy)";
        return "var(--report-unanswered)";
      }

      function renderLegend() {
        reportLegend.innerHTML = "";
        [
          { key: "Again", label: "Again", color: getReportColor("Again") },
          { key: "Hard", label: "Hard", color: getReportColor("Hard") },
          { key: "Good", label: "Good", color: getReportColor("Good") },
          { key: "Easy", label: "Easy", color: getReportColor("Easy") },
          { key: "Unanswered", label: "Unanswered", color: getReportColor("Unanswered") },
        ].forEach((item) => {
          const chip = document.createElement("div");
          chip.className = "legend-chip";
          const swatch = document.createElement("span");
          swatch.className = "legend-swatch";
          swatch.style.background = item.color;
          const text = document.createElement("span");
          text.textContent = item.label;
          chip.appendChild(swatch);
          chip.appendChild(text);
          reportLegend.appendChild(chip);
        });
      }

      function initials(str) {
        const parts = str.split(/\s+/).filter(Boolean);
        if (!parts.length) return "?";
        if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase();
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }

      function handleKeys(e) {
        if (authPanel.style.display === "flex" || reportPanel.classList.contains("open")) {
          if (e.code === "Escape") closeReports();
          return;
        }
        if (e.code === "ArrowRight") move(1);
        if (e.code === "ArrowLeft") move(-1);
        if (e.code === "Space") {
          e.preventDefault();
          if (!showAnswer) {
            reveal();
          }
        }
      }
    </script>
  </body>
</html>
